local class = require 'libs/middleclass'

Evoloop = class('Evoloop')

function Evoloop:initialize (state, x, y, board)
	self.state = state
	self.x = x
	self.y = y
	self.board = board
end

function Evoloop:next_state ()
	return self:conditions ()
end

Evoloop.static.transitions = {
	{{0,0,0,0,1}, 2}, {{1,0,2,0,2}, 1}, {{1,1,2,7,2}, 7}, {{2,0,1,7,2}, 2}, {{2,1,3,2,2}, 2}, {{4,0,1,2,5}, 0},
	{{0,0,0,0,4}, 3}, {{1,0,2,1,1}, 1}, {{1,1,2,7,3}, 5}, {{2,0,2,0,2}, 2}, {{2,1,4,2,2}, 2}, {{4,0,1,6,2}, 0},
	{{0,0,0,1,2}, 2}, {{1,0,2,1,2}, 1}, {{1,1,3,2,2}, 1}, {{2,0,2,0,3}, 2}, {{2,1,6,2,2}, 2}, {{4,0,2,1,2}, 0},
	{{0,0,0,1,5}, 2}, {{1,0,2,1,3}, 1}, {{1,1,3,3,2}, 1}, {{2,0,2,0,5}, 2}, {{2,1,7,2,2}, 2}, {{4,0,2,1,5}, 0},
	{{0,0,0,2,1}, 2}, {{1,0,2,2,1}, 1}, {{1,1,5,4,2}, 4}, {{2,0,2,0,6}, 5}, {{2,2,2,2,4}, 2}, {{4,0,2,2,2}, 1},
	{{0,0,0,2,4}, 2}, {{1,0,2,2,4}, 4}, {{1,1,5,7,2}, 7}, {{2,0,2,0,7}, 3}, {{2,2,2,2,7}, 2}, {{4,0,2,3,2}, 1},
	{{0,0,0,4,2}, 2}, {{1,0,2,2,7}, 7}, {{1,1,6,2,4}, 4}, {{2,0,2,1,2}, 2}, {{2,2,2,3,4}, 2}, {{4,0,2,6,2}, 6},
	{{0,0,0,4,5}, 2}, {{1,0,2,3,2}, 4}, {{1,1,6,2,7}, 7}, {{2,0,2,1,5}, 2}, {{2,2,2,3,7}, 2}, {{4,0,3,1,2}, 0},
	{{0,0,0,7,5}, 2}, {{1,0,2,4,1}, 4}, {{1,2,2,2,4}, 4}, {{2,0,2,2,1}, 2}, {{2,2,2,4,3}, 2}, {{4,0,3,2,2}, 1},
	{{0,0,1,0,2}, 2}, {{1,0,2,4,2}, 4}, {{1,2,2,2,7}, 7}, {{2,0,2,2,2}, 2}, {{2,2,2,4,4}, 2}, {{5,0,0,0,2}, 5},
	{{0,0,2,1,4}, 1}, {{1,0,2,4,3}, 4}, {{1,2,2,4,3}, 4}, {{2,0,2,2,3}, 2}, {{2,2,2,7,3}, 2}, {{5,0,0,1,2}, 5},
	{{0,0,2,1,7}, 1}, {{1,0,2,5,1}, 1}, {{1,2,2,7,3}, 7}, {{2,0,2,3,2}, 3}, {{2,2,2,7,7}, 2}, {{5,0,0,2,1}, 5},
	{{0,0,2,3,2}, 2}, {{1,0,2,5,2}, 7}, {{1,2,3,2,4}, 4}, {{2,0,2,4,2}, 2}, {{2,2,3,2,4}, 3}, {{5,0,0,2,3}, 2},
	{{0,1,1,2,2}, 1}, {{1,0,2,5,4}, 3}, {{1,2,3,2,7}, 7}, {{2,0,2,4,5}, 2}, {{2,2,3,2,7}, 3}, {{5,0,0,2,4}, 5},
	{{0,1,2,1,2}, 1}, {{1,0,2,5,7}, 7}, {{1,2,4,2,6}, 6}, {{2,0,2,5,2}, 5}, {{3,0,0,0,1}, 3}, {{5,0,0,2,7}, 5},
	{{0,1,2,3,2}, 1}, {{1,0,2,7,1}, 7}, {{1,2,4,3,3}, 3}, {{2,0,2,6,2}, 0}, {{3,0,0,0,2}, 2}, {{5,0,0,4,2}, 5},
	{{0,1,2,4,2}, 1}, {{1,0,2,7,2}, 7}, {{1,2,6,2,7}, 6}, {{2,0,2,6,5}, 0}, {{3,0,0,0,3}, 2}, {{5,0,0,7,2}, 5},
	{{0,1,2,4,5}, 1}, {{1,0,2,7,3}, 5}, {{2,0,0,0,1}, 2}, {{2,0,2,7,2}, 2}, {{3,0,0,0,4}, 3}, {{5,0,2,0,2}, 2},
	{{0,1,2,5,2}, 6}, {{1,0,5,1,2}, 1}, {{2,0,0,0,2}, 2}, {{2,0,2,7,5}, 2}, {{3,0,0,0,7}, 4}, {{5,0,2,0,5}, 2},
	{{0,1,2,6,2}, 6}, {{1,0,5,4,2}, 4}, {{2,0,0,0,4}, 2}, {{2,0,3,1,2}, 2}, {{3,0,0,1,2}, 3}, {{5,0,2,1,2}, 5},
	{{0,1,2,7,2}, 1}, {{1,0,5,7,2}, 7}, {{2,0,0,0,5}, 2}, {{2,0,3,2,2}, 2}, {{3,0,0,3,2}, 2}, {{5,0,2,1,5}, 2},
	{{0,1,2,7,5}, 1}, {{1,0,6,2,1}, 1}, {{2,0,0,0,6}, 0}, {{2,0,3,4,2}, 2}, {{3,0,0,4,2}, 1}, {{5,0,2,4,2}, 5},
	{{0,1,3,4,2}, 1}, {{1,0,6,2,4}, 4}, {{2,0,0,0,7}, 1}, {{2,0,3,4,5}, 2}, {{3,0,1,0,2}, 1}, {{5,0,2,7,2}, 5},
	{{0,1,3,7,2}, 1}, {{1,0,6,2,7}, 7}, {{2,0,0,1,2}, 2}, {{2,0,3,7,2}, 2}, {{3,0,1,2,5}, 0}, {{5,0,3,1,2}, 0},
	{{0,1,4,2,2}, 1}, {{1,1,1,1,2}, 1}, {{2,0,0,1,5}, 2}, {{2,0,4,1,2}, 2}, {{3,0,2,1,2}, 3}, {{6,0,2,0,2}, 2},
	{{0,1,4,2,5}, 1}, {{1,1,1,2,2}, 1}, {{2,0,0,2,1}, 2}, {{2,0,4,2,2}, 2}, {{3,0,2,4,2}, 3}, {{6,0,2,1,2}, 2},
	{{0,1,4,3,2}, 1}, {{1,1,1,2,4}, 4}, {{2,0,0,2,2}, 2}, {{2,0,4,4,2}, 2}, {{3,0,2,5,2}, 1}, {{6,0,2,2,2}, 0},
	{{0,1,4,3,5}, 1}, {{1,1,1,2,5}, 1}, {{2,0,0,2,3}, 2}, {{2,0,5,1,2}, 2}, {{3,0,2,7,2}, 3}, {{6,0,2,4,2}, 2},
	{{0,1,4,4,2}, 1}, {{1,1,1,2,7}, 7}, {{2,0,0,2,4}, 2}, {{2,0,5,4,2}, 5}, {{3,0,3,3,2}, 1}, {{6,0,2,7,2}, 2},
	{{0,1,4,6,2}, 1}, {{1,1,1,6,2}, 1}, {{2,0,0,2,6}, 0}, {{2,0,5,7,2}, 5}, {{3,1,2,1,2}, 3}, {{6,1,2,2,2}, 0},
	{{0,1,7,2,2}, 1}, {{1,1,2,1,2}, 1}, {{2,0,0,2,7}, 2}, {{2,0,6,1,2}, 5}, {{3,1,2,4,2}, 3}, {{6,2,2,2,4}, 0},
	{{0,1,7,2,5}, 1}, {{1,1,2,1,3}, 1}, {{2,0,0,3,2}, 4}, {{2,0,6,2,1}, 2}, {{3,1,2,5,2}, 1}, {{6,2,2,2,7}, 0},
	{{0,1,7,5,6}, 1}, {{1,1,2,1,5}, 1}, {{2,0,0,4,2}, 3}, {{2,0,6,4,2}, 5}, {{3,1,2,7,2}, 3}, {{7,0,1,0,2}, 0},
	{{0,1,7,6,2}, 1}, {{1,1,2,2,2}, 1}, {{2,0,0,4,5}, 2}, {{2,0,6,7,2}, 5}, {{3,2,4,2,4}, 3}, {{7,0,1,1,2}, 0},
	{{0,1,7,7,2}, 1}, {{1,1,2,2,4}, 4}, {{2,0,0,5,4}, 5}, {{2,0,7,1,2}, 2}, {{3,2,4,2,5}, 1}, {{7,0,1,2,2}, 0},
	{{1,0,0,0,1}, 1}, {{1,1,2,2,7}, 7}, {{2,0,0,5,7}, 5}, {{2,0,7,2,2}, 2}, {{3,2,4,2,7}, 3}, {{7,0,1,2,5}, 0},
	{{1,0,0,1,2}, 1}, {{1,1,2,3,2}, 1}, {{2,0,0,6,2}, 0}, {{2,0,7,7,2}, 2}, {{3,2,5,2,7}, 1}, {{7,0,1,6,2}, 0},
	{{1,0,0,2,1}, 1}, {{1,1,2,4,2}, 4}, {{2,0,0,7,2}, 2}, {{2,1,1,2,2}, 2}, {{3,2,7,2,7}, 3}, {{7,0,2,1,2}, 0},
	{{1,0,0,2,4}, 4}, {{1,1,2,4,3}, 4}, {{2,0,0,7,5}, 2}, {{2,1,2,2,2}, 2}, {{4,0,0,0,0}, 1}, {{7,0,2,1,5}, 0},
	{{1,0,0,2,7}, 7}, {{1,1,2,5,2}, 7}, {{2,0,1,0,2}, 2}, {{2,1,2,2,3}, 2}, {{4,0,0,0,2}, 1}, {{7,0,2,2,2}, 1},
	{{1,0,1,2,1}, 1}, {{1,1,2,5,4}, 3}, {{2,0,1,1,2}, 2}, {{2,1,2,2,4}, 2}, {{4,0,1,0,2}, 0}, {{7,0,2,3,2}, 0},
	{{1,0,1,2,4}, 4}, {{1,1,2,5,7}, 7}, {{2,0,1,2,2}, 2}, {{2,1,2,2,7}, 2}, {{4,0,1,1,2}, 0}, {{7,0,2,6,2}, 6},
	{{1,0,1,2,7}, 7}, {{1,1,2,6,2}, 6}, {{2,0,1,4,2}, 2}, {{2,1,2,3,2}, 3}, {{4,0,1,2,2}, 0}, {{7,0,3,1,2}, 0},
}



function Evoloop:conditions ()
	local a,b,c,d,e = self:neighbourhood()

	for k, v in pairs(Evoloop.transitions) do
		if v[1][1] == a then
			if v[2][1] == b then
				if v[3][1] == c then
					if v[4][1] == d then
						if v[5] == e then
							return v[2]
						end
					end
				end
			end
		end
	end
	return false
end

function Evoloop:neighbourhood (state)
	local a,b,c,d

	function coordinate_state (x, y)
		if self.board.present[x] == nil then
			return 0
		end
		if self.board.present[x][y] == nil then
			return 0
		end
		return self.board.present[x][y].state
	end

	a = coordinate_state(self.x-1,self.y)
	b = coordinate_state(self.x,self.y+1)
	c = coordinate_state(self.x,self.y-1)
	d = coordinate_state(self.x+1,self.y)


	return {self.state, a,b,c,d}
end